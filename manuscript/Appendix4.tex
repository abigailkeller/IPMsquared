% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Appendix 4: Generic model code},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Appendix 4: Generic model code}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

Here we provide generic model code that closely follows the model
description described in the main text, without the extra data
structures to account for data heterogeneity (as found in Appendix 3).

\section{Generic model code}\label{generic-model-code}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_code }\OtherTok{\textless{}{-}} \FunctionTok{NimbleCode}\NormalTok{(\{}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Process model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Integral projection model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \CommentTok{\# intra{-}annual change}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
    \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(Tmax}\DecValTok{{-}1}\NormalTok{)) \{}
      
      \CommentTok{\# Equation 1}
      \DocumentationTok{\#\# project}
\NormalTok{      N[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}}\NormalTok{ kernel[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, t] }\SpecialCharTok{\%*\%}
\NormalTok{        (N[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\SpecialCharTok{{-}}\NormalTok{ H\_T[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{+}
\NormalTok{        recruit\_intro[t, y] }\SpecialCharTok{*}\NormalTok{ R[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\CommentTok{\# introduce recruits, t = 6}

      \CommentTok{\# Equation 2}
      \DocumentationTok{\#\# kernel}
\NormalTok{      kernel[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, t] }\OtherTok{\textless{}{-}} \FunctionTok{seasonal\_growth}\NormalTok{(}
\NormalTok{        xinf, gk, sigma\_G, C, ts, D[t, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], n\_size, pi, x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }
\NormalTok{        lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{*}\NormalTok{ S[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
      \CommentTok{\# Equation 7}
      \DocumentationTok{\#\# natural survival}
\NormalTok{      S[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{survival}\NormalTok{(alpha, beta[y], D[t, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}
\NormalTok{    \}}
\NormalTok{  \}}
  
  \CommentTok{\# Equation 8}
  \DocumentationTok{\#\# year{-}specific natural mortality (process error, includes mark{-}recapture)}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(n\_year }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) \{}
\NormalTok{    beta[y] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dgamma}\NormalTok{(beta\_alpha, beta\_theta)}
\NormalTok{  \}}
  
  \DocumentationTok{\#\# inter{-}annual change}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(n\_year }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
      
      \CommentTok{\# Equation 9{-}10}
      \DocumentationTok{\#\# overwinter survival and seasonal growth}
      \DocumentationTok{\#\# (use stochastic N node)}
\NormalTok{      N\_stoch[y, k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbinom}\NormalTok{(}\AttributeTok{size =} \FunctionTok{seasonal\_growth}\NormalTok{(xinf, gk, sigma\_G, C, ts, }
\NormalTok{                                                    D[Tmax, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], k, pi, y[k], }
\NormalTok{                                                    lower[k], upper[k]) }\SpecialCharTok{\%*\%} 
\NormalTok{                               (N[Tmax, y, k] }\SpecialCharTok{{-}}\NormalTok{ H\_T[Tmax, y, k]),}
                             \AttributeTok{prob =}\NormalTok{ S\_o[y, k)}
      
\NormalTok{    \}}
    
    \CommentTok{\# fill deterministic N node with stochastic N node}
\NormalTok{    N[}\DecValTok{1}\NormalTok{, y }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}}\NormalTok{ N\_stoch[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
    
    \CommentTok{\# Equation 11}
    \DocumentationTok{\#\# size{-} and density{-}dependent overwinter survival}
\NormalTok{    S\_o[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{overwinter\_survival}\NormalTok{(alpha\_o[y], }
                                            \FunctionTok{sum}\NormalTok{(N[Tmax, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]), }
\NormalTok{                                            x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}
    
    \CommentTok{\# Equation 12}
    \DocumentationTok{\#\# year{-}specific intensity of overwinter mortality}
\NormalTok{    alpha\_o[y] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dgamma}\NormalTok{(alpha\_o\_alpha, alpha\_o\_theta)}
\NormalTok{  \}}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Initial population density and annual recruitment \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \CommentTok{\# Equation 12}
  \DocumentationTok{\#\# get initial size{-}structured abundance of adults {-} year 1}
\NormalTok{  N[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_init\_adult}\NormalTok{(mu\_A, sigma\_A, lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }
\NormalTok{                                      upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lambda\_A)}
  
  \CommentTok{\# Equation 14}
  \DocumentationTok{\#\# annual abundance of recruits}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
\NormalTok{   lambda\_R[m] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{T}\NormalTok{(}\FunctionTok{dnorm}\NormalTok{(mu\_lambda, }\AttributeTok{sd =}\NormalTok{ sigma\_lambda), }\DecValTok{0}\NormalTok{, }\ConstantTok{Inf}\NormalTok{)}
\NormalTok{  \}}
  
  \CommentTok{\# Equation 15}
  \DocumentationTok{\#\# annual size distribution of recruits}
\NormalTok{  R[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_init\_recruits}\NormalTok{(mu\_R, sigma\_R, lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }
\NormalTok{                                             upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }
\NormalTok{                                             lambda\_R[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year], n\_year,}
\NormalTok{                                             n\_size)}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Observation model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
    \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{Tmax) \{}
      \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
        
        \CommentTok{\# Equation 16}
        \DocumentationTok{\#\# binomial distribution with total crabs removed, n\_R}
\NormalTok{        H\_T[t, y, k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbinom}\NormalTok{(}\AttributeTok{size =} \FunctionTok{round}\NormalTok{(N[t, y, k]), }\AttributeTok{prob =}\NormalTok{ p[t, y, k])}

        \CommentTok{\# Equation 17}
        \DocumentationTok{\#\# dirichlet{-}multinomial mixture, conditional probability of capture}
\NormalTok{        alpha\_D[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, k] }\OtherTok{\textless{}{-}}\NormalTok{ p\_C[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, k] }\SpecialCharTok{*}\NormalTok{ n\_p\_dir}
\NormalTok{        H[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{ddirchmulti}\NormalTok{(}\AttributeTok{alpha =}\NormalTok{ alpha\_D[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, k],}
                                             \AttributeTok{size =}\NormalTok{ H\_T[t, y, k])}
\NormalTok{      \}}
      
      \CommentTok{\# Equations 18 {-} 20}
      \DocumentationTok{\#\# calculate hazard rate}
\NormalTok{      hazard[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_hazard}\NormalTok{(}
\NormalTok{        totalo, n\_size, h\_F\_max, h\_F\_k, h\_F\_0, h\_S\_max, h\_S\_k, h\_S\_0, h\_M\_max,}
\NormalTok{        h\_M\_A, h\_M\_sigma, f\_index[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y], s\_index[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y],}
\NormalTok{        m\_index[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y], soak\_days[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
\NormalTok{        )}

      \CommentTok{\# Equation 21}
      \DocumentationTok{\#\# total capture probability}
\NormalTok{      p[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_prob}\NormalTok{(totalo, n\_size,}
\NormalTok{                                     hazard[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}
      
      \CommentTok{\# mean conditional probability of capture}
\NormalTok{      p\_C[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_cond\_prob}\NormalTok{(totalo, n\_size,}
\NormalTok{                                                      hazard[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo,}
\NormalTok{                                                             y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}
      
\NormalTok{    \}}
\NormalTok{  \}}
  
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Integrated population model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Mark{-}recapture data \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \CommentTok{\# Equation 24}
  \DocumentationTok{\#\# draw recaptured samples, m2, from projected marked samples, n1\_project}
  \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{    m2[k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbinom}\NormalTok{(}\AttributeTok{size =} \FunctionTok{round}\NormalTok{(n1\_project[k]), }\AttributeTok{prob =}\NormalTok{ p\_mc[k])}
\NormalTok{  \}}
  
  \CommentTok{\# Equation 25}
  \DocumentationTok{\#\# total capture probability with mark{-}recapture data}
\NormalTok{  p\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_prob}\NormalTok{(totalo\_mc, n\_size,}
\NormalTok{                              hazard\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}
  
  \CommentTok{\# size{-}dependent hazard rates with mark{-}recapture data}
\NormalTok{  hazard\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_hazard}\NormalTok{(}
\NormalTok{    totalo\_mc, n\_size, h\_F\_max, h\_F\_k, h\_F\_0, h\_S\_max, h\_S\_k, h\_S\_0, h\_M\_max,}
\NormalTok{        h\_M\_A, h\_M\_sigma, f\_index\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc], s\_index\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc,],}
\NormalTok{        m\_index\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc], soak\_days[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
\NormalTok{  )}
  
  \CommentTok{\# Equation 26}
  \DocumentationTok{\#\# apply kernel from time of marking to time of recapture}
\NormalTok{  n1\_project[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}}\NormalTok{ kernel\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\SpecialCharTok{\%*\%}\NormalTok{ n1[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
  
\NormalTok{  kernel\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{seasonal\_growth}\NormalTok{(xinf, gk, sigma\_G, C, ts, }
\NormalTok{                                                   D\_mc[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], n\_size,  pi, }
\NormalTok{                                                   x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }
\NormalTok{                                                   upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{*} 
    \FunctionTok{survival}\NormalTok{(alpha, beta[}\DecValTok{5}\NormalTok{], D\_mc[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Growth model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \CommentTok{\# incorporated hierarchically as informative priors in the unified model}
  \CommentTok{\# asymptotic size}
\NormalTok{  xinf }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(inf\_prior[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{], }\AttributeTok{sd =}\NormalTok{ inf\_prior[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# growth rate}
\NormalTok{  gk }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(inf\_prior[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{], }\AttributeTok{sd =}\NormalTok{ inf\_prior[}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# amplitude of growth oscillations}
\NormalTok{  C }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(inf\_prior[}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{], }\AttributeTok{sd =}\NormalTok{ inf\_prior[}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# inflection point of growth oscillations}
\NormalTok{  ts }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(inf\_prior[}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{], }\AttributeTok{sd =}\NormalTok{ inf\_prior[}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  
  
  
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Vague priors \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \DocumentationTok{\#\#}
  \CommentTok{\# size selectivity parameters}
  \DocumentationTok{\#\#}

  \CommentTok{\# minnow max. hazard rate}
\NormalTok{  h\_M\_max }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# minnow max. size of capture}
\NormalTok{  h\_M\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# minnow sigma of gaussian size selectivity curve}
\NormalTok{  h\_M\_sigma }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# fukui max. hazard rate}
\NormalTok{  h\_F\_max }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# fukui k of logistic size selectivity curve}
\NormalTok{  h\_F\_k }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# fukui midpoint of logistic size selectivity curve}
\NormalTok{  h\_F\_0 }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{6}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{6}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# shrimp max. hazard rate}
\NormalTok{  h\_S\_max }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{7}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{7}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# shrimp k of logistic size selectivity curve}
\NormalTok{  h\_S\_k }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{8}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{8}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# shrimp midpoint of logistic size selectivity curve}
\NormalTok{  h\_S\_0 }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{9}\NormalTok{, }\DecValTok{2}\NormalTok{])}

  \DocumentationTok{\#\#}
  \CommentTok{\# IPM {-} natural mortality}
  \DocumentationTok{\#\#}

  \CommentTok{\# gamma distributions shape for instantaneous intensity of mortality}
\NormalTok{  beta\_alpha }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{10}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# gamma distributions rate for instantaneous intensity of mortality}
\NormalTok{  beta\_theta }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{11}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{11}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# size{-}dependent overwinter natural mortality, shared across all sites}
\NormalTok{  alpha }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{12}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{12}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# gamma distribution shape {-} instantaneous intensity of overwinter mortality}
\NormalTok{  alpha\_o\_alpha }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{13}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{13}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  \CommentTok{\# gamma distribution rate {-} instantaneous intensity of overwinter mortality}
\NormalTok{  alpha\_o\_theta }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{14}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{14}\NormalTok{, }\DecValTok{2}\NormalTok{])}

  \DocumentationTok{\#\#}
  \CommentTok{\# IPM {-} growth}
  \DocumentationTok{\#\#}
  
  \CommentTok{\# growth error}
\NormalTok{  sigma\_G }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{15}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{15}\NormalTok{, }\DecValTok{2}\NormalTok{])}

  \DocumentationTok{\#\#}
  \CommentTok{\# observation process}
  \DocumentationTok{\#\#}
  \CommentTok{\# dirichlet multinomial (overdispersion in count data)}
\NormalTok{  ro\_dir }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbeta}\NormalTok{(priors[}\DecValTok{16}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{16}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\NormalTok{  n\_p\_dir }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ro\_dir) }\SpecialCharTok{/}\NormalTok{ ro\_dir}

  \DocumentationTok{\#\#}
  \CommentTok{\# initial population density and annual recruitment}
  \DocumentationTok{\#\#}

  \CommentTok{\# initial adult size (mean and sd)}
\NormalTok{  mu\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{17}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{17}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\NormalTok{  sigma\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{18}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{18}\NormalTok{, }\DecValTok{2}\NormalTok{])}

  \CommentTok{\# initial recruit size (mean and sd)}
\NormalTok{  mu\_R }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{19}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{19}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\NormalTok{  sigma\_R }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{20}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{20}\NormalTok{, }\DecValTok{2}\NormalTok{])}

  \CommentTok{\# abundance of recruits (mean and sd)}
\NormalTok{  mu\_lambda }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{21}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{21}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\NormalTok{  sigma\_lambda }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{22}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{22}\NormalTok{, }\DecValTok{2}\NormalTok{])}

  \CommentTok{\# abundance of adults in year 1}
\NormalTok{  lambda\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(priors[}\DecValTok{23}\NormalTok{, }\DecValTok{1}\NormalTok{], priors[}\DecValTok{23}\NormalTok{, }\DecValTok{2}\NormalTok{])}
  
  
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\section{Nimble functions}\label{nimble-functions}

\subsection{Process model functions}\label{process-model-functions}

\subsubsection{Initial population density of
adults}\label{initial-population-density-of-adults}

This function corresponds to equation 1 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# initial size distribution of adults {-} year 1}
\NormalTok{get\_init\_adult }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{mu\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{sigma\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{lower =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                 \AttributeTok{lambda\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    
    \CommentTok{\# moment match from normal to gamma}
\NormalTok{    var }\OtherTok{\textless{}{-}}\NormalTok{ sigma\_A }\SpecialCharTok{\^{}} \DecValTok{2}
\NormalTok{    shape }\OtherTok{\textless{}{-}}\NormalTok{ mu\_A }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{/}\NormalTok{ var}
\NormalTok{    rate }\OtherTok{\textless{}{-}}\NormalTok{ mu\_A }\SpecialCharTok{/}\NormalTok{ var}
\NormalTok{    prop\_adult }\OtherTok{\textless{}{-}} \FunctionTok{pgamma}\NormalTok{(}\AttributeTok{q =}\NormalTok{ upper, }\AttributeTok{shape =}\NormalTok{ shape, }\AttributeTok{rate =}\NormalTok{ rate) }\SpecialCharTok{{-}}
      \FunctionTok{pgamma}\NormalTok{(}\AttributeTok{q =}\NormalTok{ lower, }\AttributeTok{shape =}\NormalTok{ shape, }\AttributeTok{rate =}\NormalTok{ rate)}
    
    \CommentTok{\# get initial size{-}structured abundance of adults}
\NormalTok{    out }\OtherTok{\textless{}{-}}\NormalTok{ prop\_adult }\SpecialCharTok{*}\NormalTok{ lambda\_A}

    \FunctionTok{return}\NormalTok{(out)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Size-structured
recruitment}\label{size-structured-recruitment}

This function corresponds to equation 15 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# annual size distributions of recruit}
\NormalTok{get\_init\_recruits }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{mu\_R =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{sigma\_R =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{lower =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                 \AttributeTok{lambda\_R =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{n\_year =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
    
    \CommentTok{\# create empty array}
\NormalTok{    out }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{ncol =}\NormalTok{ n\_size, }\AttributeTok{nrow =}\NormalTok{ n\_year)}

\NormalTok{    var }\OtherTok{\textless{}{-}}\NormalTok{ sigma\_R }\SpecialCharTok{\^{}} \DecValTok{2}
\NormalTok{    shape }\OtherTok{\textless{}{-}}\NormalTok{ mu\_R }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{/}\NormalTok{ var}
\NormalTok{    rate }\OtherTok{\textless{}{-}}\NormalTok{ mu\_R }\SpecialCharTok{/}\NormalTok{ var}
\NormalTok{    prop\_recruit }\OtherTok{\textless{}{-}} \FunctionTok{pgamma}\NormalTok{(}\AttributeTok{q =}\NormalTok{ upper, }\AttributeTok{shape =}\NormalTok{ shape, }\AttributeTok{rate =}\NormalTok{ rate) }\SpecialCharTok{{-}}
      \FunctionTok{pgamma}\NormalTok{(}\AttributeTok{q =}\NormalTok{ lower, }\AttributeTok{shape =}\NormalTok{ shape, }\AttributeTok{rate =}\NormalTok{ rate)}
      
    \CommentTok{\# get initial size{-}structured abundance of recruits}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
\NormalTok{      out[i, ] }\OtherTok{\textless{}{-}}\NormalTok{ prop\_recruit[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\SpecialCharTok{*}\NormalTok{ lambda\_R[i]}
\NormalTok{    \}}

    \FunctionTok{return}\NormalTok{(out)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Seasonal growth}\label{seasonal-growth}

This function corresponds to equations 3-5 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# function for seasonal growth kernel}
\NormalTok{seasonal\_growth }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{xinf =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{sigma\_G =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{C =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{ts =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{D =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                 \AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{pi =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                 \AttributeTok{lower =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}

    \CommentTok{\# create empty array}
\NormalTok{    array }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{ncol =}\NormalTok{ n\_size, }\AttributeTok{nrow =}\NormalTok{ n\_size)}

    \CommentTok{\# season adjusted params}
\NormalTok{    S\_t }\OtherTok{\textless{}{-}}\NormalTok{ (C }\SpecialCharTok{*}\NormalTok{ k }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*}\NormalTok{ (D[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ ts)))}
\NormalTok{    S\_t0 }\OtherTok{\textless{}{-}}\NormalTok{ (C }\SpecialCharTok{*}\NormalTok{ k }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*}\NormalTok{ (D[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ ts)))}

    \CommentTok{\# p(y"|y)}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{      increment }\OtherTok{\textless{}{-}}\NormalTok{ (xinf }\SpecialCharTok{{-}}\NormalTok{ x[i]) }\SpecialCharTok{*}
\NormalTok{        (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{k }\SpecialCharTok{*}\NormalTok{ (D[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ D[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{{-}}\NormalTok{ S\_t }\SpecialCharTok{+}\NormalTok{ S\_t0))}
\NormalTok{      mean }\OtherTok{\textless{}{-}}\NormalTok{ x[i] }\SpecialCharTok{+}\NormalTok{ increment}
\NormalTok{      array[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, i] }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{pnorm}\NormalTok{(upper, mean, }\AttributeTok{sd =}\NormalTok{ sigma\_G) }\SpecialCharTok{{-}}
                               \FunctionTok{pnorm}\NormalTok{(lower, mean, }\AttributeTok{sd =}\NormalTok{ sigma\_G))}
\NormalTok{    \}}

    \CommentTok{\# normalize}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{      array[, i] }\OtherTok{\textless{}{-}}\NormalTok{ array[, i] }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(array[, i])}
\NormalTok{    \}}
  \FunctionTok{return}\NormalTok{(array)}
\NormalTok{\}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Natural survival}\label{natural-survival}

This function corresponds to equation 7 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# natural (non{-}winter) survival}
\NormalTok{survival }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{alpha =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{beta =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{D =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                 \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    
    \CommentTok{\# get survival rate}
\NormalTok{    out }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(D[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ D[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*}\NormalTok{ (beta }\SpecialCharTok{+}\NormalTok{ alpha }\SpecialCharTok{/}\NormalTok{ x }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{))}

    \FunctionTok{return}\NormalTok{(out)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Density-dependent overwinter
survival}\label{density-dependent-overwinter-survival}

This function corresponds to equation 9-10 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# density{-} and size{-}dependent overwinter survival}
\NormalTok{overwinter\_survival }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{alpha\_o =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{N =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                 \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    
    \CommentTok{\# get probability of survival}
\NormalTok{    out }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(alpha\_o }\SpecialCharTok{*} \FunctionTok{sum}\NormalTok{(N) }\SpecialCharTok{/}\NormalTok{ x }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{))}

    \FunctionTok{return}\NormalTok{(out)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Observation model
functions}\label{observation-model-functions}

\subsubsection{Conditional multinomial observation
model}\label{conditional-multinomial-observation-model}

This function corresponds to equations 18-20 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# calculate trap hazard rate of obs j, based on trap type and soak days}
\NormalTok{calc\_hazard }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{nobs =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_F\_max =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{h\_F\_k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_F\_0 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_S\_max =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{h\_S\_k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_S\_0 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_M\_max =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{h\_M\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_M\_sigma =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{f\_index =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }
                 \AttributeTok{s\_index =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{m\_index =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }
                 \AttributeTok{soak\_days =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}

    \CommentTok{\# create empty array}
\NormalTok{    array }\OtherTok{\textless{}{-}} \FunctionTok{array}\NormalTok{(}\AttributeTok{init =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{dim =} \FunctionTok{c}\NormalTok{(nobs, n\_size))}
    
    \CommentTok{\# loop through observations}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs) \{}
      \CommentTok{\# P(capture)}
\NormalTok{      array[j, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{size\_sel\_log}\NormalTok{(}\AttributeTok{pmax =}\NormalTok{ h\_F\_max, }\AttributeTok{k =}\NormalTok{ h\_F\_k,}
                                         \AttributeTok{midpoint =}\NormalTok{ h\_F\_0, }\AttributeTok{x =}\NormalTok{ x) }\SpecialCharTok{*}
\NormalTok{        f\_index[j] }\SpecialCharTok{*}\NormalTok{ soak\_days[j] }\SpecialCharTok{+}
        \FunctionTok{size\_sel\_log}\NormalTok{(}\AttributeTok{pmax =}\NormalTok{ h\_S\_max, }\AttributeTok{k =}\NormalTok{ h\_S\_k, }\AttributeTok{midpoint =}\NormalTok{ h\_S\_0, }\AttributeTok{x =}\NormalTok{ x) }\SpecialCharTok{*}
\NormalTok{        s\_index[j] }\SpecialCharTok{*}\NormalTok{ soak\_days[j] }\SpecialCharTok{+}
        \FunctionTok{size\_sel\_norm}\NormalTok{(}\AttributeTok{pmax =}\NormalTok{ h\_M\_max, }\AttributeTok{xmax =}\NormalTok{ h\_M\_A, }\AttributeTok{sigma =}\NormalTok{ h\_M\_sigma, }\AttributeTok{x =}\NormalTok{ x) }\SpecialCharTok{*}
\NormalTok{        m\_index[j] }\SpecialCharTok{*}\NormalTok{ soak\_days[j]}
\NormalTok{    \}}
      \FunctionTok{return}\NormalTok{(array)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

These functions correspond to equation 21 in main text

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# calculate conditional probability of capture}
\NormalTok{calc\_cond\_prob }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{nobs =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{hazard =} \FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
    
    \CommentTok{\# create empty array}
\NormalTok{    array }\OtherTok{\textless{}{-}} \FunctionTok{array}\NormalTok{(}\AttributeTok{init =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{dim =} \FunctionTok{c}\NormalTok{(nobs, n\_size))}
    \CommentTok{\# loop through sizes}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
      \CommentTok{\#P(capture in trap j | captured at all)}
\NormalTok{      array[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k] }\OtherTok{\textless{}{-}}\NormalTok{ hazard[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k] }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(hazard[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k])}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(array)}
\NormalTok{  \}}
\NormalTok{)}

\CommentTok{\# calculate total capture probability}
\NormalTok{calc\_prob }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{nobs =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{hazard =} \FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}

    \CommentTok{\# create empty array}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, n\_size)}

    \CommentTok{\# loop through sizes}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
      \CommentTok{\# 1 {-} exp({-}P(captured at all))}
\NormalTok{      p[k] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{sum}\NormalTok{(hazard[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k]))}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Size-selective hazard
rates}\label{size-selective-hazard-rates}

These functions correspond to equations 18-20 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# bell{-}shaped size selective hazard rate}
\NormalTok{size\_sel\_norm }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  \CommentTok{\# input and output types}
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{pmax =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{xmax =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{sigma =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{      vector }\OtherTok{\textless{}{-}}\NormalTok{ pmax }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(x }\SpecialCharTok{{-}}\NormalTok{ xmax) }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ sigma }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{))}

    \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{  \}}
\NormalTok{)}

\CommentTok{\# logistic size selective hazard rate}
\NormalTok{size\_sel\_log }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{pmax =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{midpoint =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    
\NormalTok{    vector }\OtherTok{\textless{}{-}}\NormalTok{ pmax }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{k }\SpecialCharTok{*}\NormalTok{ (x }\SpecialCharTok{{-}}\NormalTok{ midpoint)))}

    \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{  \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Dirichlet-multinomial
mixture}\label{dirichlet-multinomial-mixture}

These functions correspond to equation 17 in main text.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# define dirichlet multinomial mixture}
\CommentTok{\# pdf}
\NormalTok{ddirchmulti }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{alpha =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                 \AttributeTok{log =} \FunctionTok{integer}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{default =} \DecValTok{0}\NormalTok{)) \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{    logProb }\OtherTok{\textless{}{-}} \FunctionTok{lgamma}\NormalTok{(size }\SpecialCharTok{+} \DecValTok{1}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(x }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+} \FunctionTok{lgamma}\NormalTok{(}\FunctionTok{sum}\NormalTok{(alpha)) }\SpecialCharTok{{-}}
      \FunctionTok{sum}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(alpha)) }\SpecialCharTok{+} \FunctionTok{sum}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(alpha }\SpecialCharTok{+}\NormalTok{ x)) }\SpecialCharTok{{-}}
      \FunctionTok{lgamma}\NormalTok{(}\FunctionTok{sum}\NormalTok{(alpha) }\SpecialCharTok{+}\NormalTok{ size)}
    \ControlFlowTok{if}\NormalTok{ (log) }\FunctionTok{return}\NormalTok{(logProb)}
    \ControlFlowTok{else} \FunctionTok{return}\NormalTok{(}\FunctionTok{exp}\NormalTok{(logProb))}
\NormalTok{  \})}
\CommentTok{\# random number generator}
\NormalTok{rdirchmulti }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
  \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \FunctionTok{integer}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{alpha =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{)) \{}
    \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{!=} \DecValTok{1}\NormalTok{) }\FunctionTok{print}\NormalTok{(}\StringTok{"rdirchmulti only allows n = 1; using n = 1."}\NormalTok{)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{rdirch}\NormalTok{(}\DecValTok{1}\NormalTok{, alpha)}
    \FunctionTok{return}\NormalTok{(}\FunctionTok{rmulti}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{size =}\NormalTok{ size, }\AttributeTok{prob =}\NormalTok{ p))}
\NormalTok{  \})}
\end{Highlighting}
\end{Shaded}


\end{document}
