% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Appendix 3: Model code},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Appendix 3: Model code}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

This appendix contains the model code, written and implemented with the
software \texttt{nimble} and implemented in parallel with the
\texttt{parallel} package. See Appendix 4 for more generic, modular
model code that closely follows the model description in the main text
without the extra data structures required to account for the
heterogeneous data used to fit the model.

First data will be read in:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# read in time series data}
\NormalTok{H }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/counts.rds"}\NormalTok{)}
\NormalTok{H\_T }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/n\_cap.rds"}\NormalTok{)}

\CommentTok{\# read in time series constants}
\NormalTok{index }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/index.rds"}\NormalTok{)}
\NormalTok{D }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/index\_frac.rds"}\NormalTok{)}
\NormalTok{totalt }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/totalt.rds"}\NormalTok{)}
\NormalTok{totalo }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/totalo.rds"}\NormalTok{)}
\NormalTok{soak\_days }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/soak\_days.rds"}\NormalTok{)}
\NormalTok{m\_index }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/m\_index.rds"}\NormalTok{)}
\NormalTok{f\_index }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/f\_index.rds"}\NormalTok{)}
\NormalTok{s\_index }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/s\_index.rds"}\NormalTok{)}
\NormalTok{recruit\_intro }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/recruit\_intro.rds"}\NormalTok{)}
\NormalTok{additionalt }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/additionalt.rds"}\NormalTok{)}

\CommentTok{\# read in mark{-}recapture data}
\NormalTok{n1\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/n1\_mc.rds"}\NormalTok{)}
\NormalTok{m2\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/m2\_mc.rds"}\NormalTok{)}

\CommentTok{\# read in mark{-}recapture constants}
\NormalTok{D\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/mc\_index.rds"}\NormalTok{)}
\NormalTok{totalo\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/totalo\_mc.rds"}\NormalTok{)}
\NormalTok{soak\_days\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/soak\_days\_mc.rds"}\NormalTok{)}
\NormalTok{f\_index\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/f\_index\_mc.rds"}\NormalTok{)}
\NormalTok{s\_index\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/s\_index\_mc.rds"}\NormalTok{)}
\NormalTok{m\_index\_mc }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/m\_index\_mc.rds"}\NormalTok{)}

\CommentTok{\# read in IPM constants}
\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/b.rds"}\NormalTok{)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"data/model\_data/x.rds"}\NormalTok{)}


\CommentTok{\# Write model code}
\NormalTok{model\_code }\OtherTok{\textless{}{-}} \FunctionTok{nimbleCode}\NormalTok{(\{}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Process model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Integral projection model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \CommentTok{\# project to first observed time period {-} year 2{-}4}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{n\_year) \{}
\NormalTok{    N[}\DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_kernel}\NormalTok{(xinf, gk, sigma\_G, C,}
\NormalTok{                                    ts, }\DecValTok{0}\NormalTok{, D[}\DecValTok{1}\NormalTok{, y], n\_size, pi,}
\NormalTok{                                    x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                    upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], S[}\DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{\%*\%}
\NormalTok{      N\_overwinter[y }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
    
    \DocumentationTok{\#\# natural survival}
\NormalTok{    S[}\DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{survival}\NormalTok{(alpha, beta[y], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }\DecValTok{0}\NormalTok{, D[}\DecValTok{1}\NormalTok{, y])}
\NormalTok{  \}}
  
  \CommentTok{\# intra{-}annual change}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
    \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(totalt[y]}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)) \{}

      \CommentTok{\# Equations 1 {-} 2}
      \DocumentationTok{\#\# project}
\NormalTok{      N[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_kernel}\NormalTok{(xinf, gk, sigma\_G,}
\NormalTok{                                          C, ts, D[t, y],}
\NormalTok{                                          D[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y], n\_size, pi,}
\NormalTok{                                          x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                          upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                          S[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])  }\SpecialCharTok{\%*\%}
\NormalTok{        (N[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\SpecialCharTok{{-}}\NormalTok{ H\_T[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{+}
\NormalTok{        recruit\_intro[t, y] }\SpecialCharTok{*}\NormalTok{ R[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\CommentTok{\# introduce recruits, t = 6}

      \CommentTok{\# Equation 7}
      \DocumentationTok{\#\# natural survival}
\NormalTok{      S[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{survival}\NormalTok{(alpha, beta[y], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], D[t, y],}
\NormalTok{                                        D[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y])}

\NormalTok{    \}}
\NormalTok{  \}}

  \CommentTok{\# Equation 8}
  \DocumentationTok{\#\# year{-}specific natural mortality (process error, includes mark{-}recapture)}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(n\_year }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) \{}
\NormalTok{    beta[y] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dgamma}\NormalTok{(beta\_alpha, beta\_theta)}
\NormalTok{  \}}

  \CommentTok{\# project all years to the same intra{-}annual end point by}
  \CommentTok{\# applying the growth kernel and natural mortality}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year\_short) \{}
    \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in}\NormalTok{ additionalt[year\_short[y], }\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\NormalTok{additionalt[year\_short[y], }\DecValTok{2}\NormalTok{]) \{}

      \CommentTok{\# Equations 1 {-} 2}
      \DocumentationTok{\#\# project}
\NormalTok{      N[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, year\_short[y], }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_kernel}\NormalTok{(xinf, gk, sigma\_G,}
\NormalTok{                                                      C, ts,}
\NormalTok{                                                      D[t, year\_short[y]],}
\NormalTok{                                                      D[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, year\_short[y]],}
\NormalTok{                                                      n\_size, pi,}
\NormalTok{                                                      x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                                      lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                                      upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                                      S[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, year\_short[y],}
                                                        \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{\%*\%}
\NormalTok{        N[t, year\_short[y], }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}

\NormalTok{      S[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, year\_short[y], }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{survival}\NormalTok{(alpha, beta[y], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                                    D[t, year\_short[y]],}
\NormalTok{                                                    D[t }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, year\_short[y]])}
\NormalTok{    \}}
\NormalTok{  \}}


  \DocumentationTok{\#\# inter{-}annual change}
  \CommentTok{\# project to new year with seasonal growth}
  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(n\_year }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) \{}
\NormalTok{    wgrowth\_N[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_kernel}\NormalTok{(xinf, gk, sigma\_G, C, ts,}
\NormalTok{                                         max\_D, }\DecValTok{1}\NormalTok{,}
\NormalTok{                                         n\_size, pi, x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                         lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                         ones[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{\%*\%}
\NormalTok{      N[additionalt[y, }\DecValTok{2}\NormalTok{] }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}

    \CommentTok{\# total density after seasonal growth}
\NormalTok{    wgrowth\_N\_sum[y] }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(wgrowth\_N[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}

    \CommentTok{\# size{-} and density{-}dependent overwinter mortality}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{      N\_overwinter[y, k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbinom}\NormalTok{(}\AttributeTok{size =} \FunctionTok{round}\NormalTok{(wgrowth\_N[y, k]),}
                                  \AttributeTok{prob =}\NormalTok{ S\_o[y, k])}
\NormalTok{    \}}

    \CommentTok{\# Equation 11}
    \DocumentationTok{\#\# size{-} and density{-}dependent overwinter survival}
\NormalTok{    S\_o[y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{overwinter\_survival}\NormalTok{(alpha\_o[y],}
\NormalTok{                                            wgrowth\_N\_sum[y],}
\NormalTok{                                            x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}

    \CommentTok{\# Equation 12}
    \DocumentationTok{\#\# year{-}specific intensity of overwinter mortality}
\NormalTok{    alpha\_o[y] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dgamma}\NormalTok{(alpha\_o\_alpha, alpha\_o\_theta)}
\NormalTok{  \}}

  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Initial population density and annual recruitment \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

  \CommentTok{\# Equation 13}
  \DocumentationTok{\#\# get initial size{-}structured abundance of adults {-} year 1}
\NormalTok{  N\_init[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_init\_adult}\NormalTok{(mu\_A, sigma\_A,}
\NormalTok{                                     lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lambda\_A)}

  \CommentTok{\# project to first observed time period {-} year 1}
\NormalTok{  N[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_kernel}\NormalTok{(xinf, gk, sigma\_G, C,}
\NormalTok{                                  ts, }\DecValTok{0}\NormalTok{, D[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{], n\_size, pi,}
\NormalTok{                                  x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                  upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], S[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{\%*\%}
\NormalTok{    N\_init[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}

  \DocumentationTok{\#\# natural survival}
\NormalTok{  S[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{survival}\NormalTok{(alpha, beta[}\DecValTok{1}\NormalTok{], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], }\DecValTok{0}\NormalTok{, D[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{])}

  \CommentTok{\# Equation 14}
  \DocumentationTok{\#\# annual abundance of recruits}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
\NormalTok{    lambda\_R[m] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{T}\NormalTok{(}\FunctionTok{dnorm}\NormalTok{(mu\_lambda, }\AttributeTok{sd =}\NormalTok{ sigma\_lambda), }\DecValTok{0}\NormalTok{, }\ConstantTok{Inf}\NormalTok{)}
\NormalTok{  \}}

  \CommentTok{\# Equation 15}
  \DocumentationTok{\#\# annual size distribution of recruits}
\NormalTok{  R[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_init\_recruits}\NormalTok{(mu\_R, sigma\_R, lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                             upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                             lambda\_R[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year], n\_year,}
\NormalTok{                                             n\_size)}


  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Observation model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

  \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
    \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{totalt[y]) \{}
      \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}

        \CommentTok{\# Equation 16}
        \DocumentationTok{\#\# binomial distribution with total crabs removed, H\_T}
\NormalTok{        H\_T[t, y, k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbinom}\NormalTok{(}\AttributeTok{size =} \FunctionTok{round}\NormalTok{(N[t, y, k]), }\AttributeTok{prob =}\NormalTok{ p[t, y, k])}

        \CommentTok{\# Equation 17}
        \DocumentationTok{\#\# dirichlet{-}multinomial mixture, conditional probability of capture}
\NormalTok{        alpha\_D[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y, k] }\OtherTok{\textless{}{-}}\NormalTok{ p\_C[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y],}
\NormalTok{                                                y, k] }\SpecialCharTok{*}\NormalTok{ n\_p\_dir}
\NormalTok{        H[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y],}
\NormalTok{            y, k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{ddirchmulti}\NormalTok{(}\AttributeTok{alpha =}\NormalTok{ alpha\_D[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y, k],}
                                \AttributeTok{size =}\NormalTok{ H\_T[t, y, k])}
\NormalTok{      \}}

      \CommentTok{\# Equations 18 {-} 20}
      \DocumentationTok{\#\# calculate hazard rate}
\NormalTok{      hazard[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_hazard}\NormalTok{(}
\NormalTok{        totalo[t, y], n\_size, h\_F\_max, h\_F\_k, h\_F\_0, h\_S\_max, h\_S\_k, h\_S\_0,}
\NormalTok{        h\_M\_max, h\_M\_A, h\_M\_sigma, f\_index[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y],}
\NormalTok{        s\_index[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y], m\_index[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y],}
\NormalTok{        soak\_days[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
\NormalTok{      )}

      \CommentTok{\# Equation 21}
      \DocumentationTok{\#\# total capture probability}
\NormalTok{      p[t, y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_prob}\NormalTok{(totalo[t, y], n\_size,}
\NormalTok{                                     hazard[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y], y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}

      \CommentTok{\# mean conditional probability of capture}
\NormalTok{      p\_C[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y],}
\NormalTok{          y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_cond\_prob}\NormalTok{(totalo[t, y], n\_size,}
\NormalTok{                                         hazard[t, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo[t, y],}
\NormalTok{                                                y, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}

\NormalTok{    \}}
\NormalTok{  \}}

  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Integrated population model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Mark{-}recapture data \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

  \CommentTok{\# Equation 24}
  \DocumentationTok{\#\# draw recaptured samples, m2, from projected marked samples, n1\_project}
  \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{    m2[k] }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbinom}\NormalTok{(}\AttributeTok{size =} \FunctionTok{round}\NormalTok{(n1\_project[k]), }\AttributeTok{prob =}\NormalTok{ p\_mc[k])}
\NormalTok{  \}}

  \CommentTok{\# Equation 25}
  \DocumentationTok{\#\# total capture probability with mark{-}recapture data}
\NormalTok{  p\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_prob}\NormalTok{(totalo\_mc, n\_size,}
\NormalTok{                              hazard\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size])}

  \CommentTok{\# size{-}dependent hazard rates with mark{-}recapture data}
\NormalTok{  hazard\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{calc\_hazard}\NormalTok{(}
\NormalTok{    totalo\_mc, n\_size, h\_F\_max, h\_F\_k, h\_F\_0, h\_S\_max, h\_S\_k, h\_S\_0, h\_M\_max,}
\NormalTok{    h\_M\_A, h\_M\_sigma, f\_index\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc], s\_index\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc],}
\NormalTok{    m\_index\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc], soak\_days\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{totalo\_mc], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}
\NormalTok{  )}

  \CommentTok{\# Equation 26}
  \DocumentationTok{\#\# apply kernel from time of marking to time of recapture}
\NormalTok{  n1\_project[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{get\_kernel}\NormalTok{(xinf, gk, sigma\_G, C, ts, D\_mc[}\DecValTok{1}\NormalTok{], D\_mc[}\DecValTok{2}\NormalTok{],}
\NormalTok{                                     n\_size, pi, x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], lower[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size],}
\NormalTok{                                     upper[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], S\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]) }\SpecialCharTok{\%*\%}
\NormalTok{    n1[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size]}

\NormalTok{  S\_mc[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{survival}\NormalTok{(alpha, beta[}\DecValTok{5}\NormalTok{], x[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size], D\_mc[}\DecValTok{1}\NormalTok{], D\_mc[}\DecValTok{2}\NormalTok{])}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Growth model \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \CommentTok{\# asymptotic size {-}{-} (from seasonal growth posterior)}
\NormalTok{  xinf }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(}\FloatTok{98.5}\NormalTok{, }\AttributeTok{sd =} \FloatTok{11.2}\NormalTok{)}
  \CommentTok{\# growth rate {-}{-} (from seasonal growth posterior)}
\NormalTok{  gk }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(}\FloatTok{0.55}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.16}\NormalTok{)}
  \CommentTok{\# amplitude of growth oscillations {-}{-} (from seasonal growth posterior)}
\NormalTok{  C }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(}\FloatTok{0.95}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.48}\NormalTok{)}
  \CommentTok{\# inflection point of growth oscillations {-}{-} (from seasonal growth posterior)}
\NormalTok{  ts }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.72}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.14}\NormalTok{)}
  
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Vague priors \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \CommentTok{\# Prior distributions \#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  
  \DocumentationTok{\#\#}
  \CommentTok{\# size selectivity parameters}
  \DocumentationTok{\#\#}
  
  \CommentTok{\# minnow max. hazard rate}
\NormalTok{  h\_M\_max }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.1}\NormalTok{)}
  \CommentTok{\# minnow max. size of capture}
\NormalTok{  h\_M\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{35}\NormalTok{, }\DecValTok{60}\NormalTok{)}
  \CommentTok{\# minnow sigma of gaussian size selectivity curve}
\NormalTok{  h\_M\_sigma }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{10}\NormalTok{)}
  \CommentTok{\# fukui max. hazard rate}
\NormalTok{  h\_F\_max }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.1}\NormalTok{)}
  \CommentTok{\# fukui k of logistic size selectivity curve}
\NormalTok{  h\_F\_k }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{)}
  \CommentTok{\# fukui midpoint of logistic size selectivity curve}
\NormalTok{  h\_F\_0 }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{100}\NormalTok{)}
  \CommentTok{\# shrimp max. hazard rate}
\NormalTok{  h\_S\_max }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.1}\NormalTok{)}
  \CommentTok{\# shrimp k of logistic size selectivity curve}
\NormalTok{  h\_S\_k }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{)}
  \CommentTok{\# shrimp midpoint of logistic size selectivity curve}
\NormalTok{  h\_S\_0 }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{100}\NormalTok{)}
  
  \DocumentationTok{\#\#}
  \CommentTok{\# IPM {-} natural mortality}
  \DocumentationTok{\#\#}
  
  \CommentTok{\# gamma distributions shape for instantaneous intensity of mortality}
\NormalTok{  beta\_alpha }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{)}
  \CommentTok{\# gamma distributions rate for instantaneous intensity of mortality}
\NormalTok{  beta\_theta }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{150}\NormalTok{)}
  \CommentTok{\# size{-}dependent overwinter natural mortality, shared across all sites}
\NormalTok{  alpha }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10000}\NormalTok{)}
  \CommentTok{\# gamma distribution shape {-} instantaneous probability of overwinter mortality}
\NormalTok{  alpha\_o\_alpha }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{50}\NormalTok{)}
  \CommentTok{\# gamma distribution rate {-} instantaneous probability of overwinter mortality}
\NormalTok{  alpha\_o\_theta }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{150}\NormalTok{)}
  
  \DocumentationTok{\#\#}
  \CommentTok{\# IPM {-} growth}
  \DocumentationTok{\#\#}
  
  \CommentTok{\# growth error}
\NormalTok{  sigma\_G }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{4}\NormalTok{)}
  
  \DocumentationTok{\#\#}
  \CommentTok{\# observation process}
  \DocumentationTok{\#\#}
  \CommentTok{\# dirichlet multinomial (overdispersion in count data)}
\NormalTok{  ro\_dir }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dbeta}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{  n\_p\_dir }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ro\_dir) }\SpecialCharTok{/}\NormalTok{ ro\_dir}
  
  \DocumentationTok{\#\#}
  \CommentTok{\# initial population density and annual recruitment}
  \DocumentationTok{\#\#}
  
  \CommentTok{\# initial adult size (mean and sd)}
\NormalTok{  mu\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\FloatTok{3.25}\NormalTok{, }\FloatTok{4.5}\NormalTok{)}
\NormalTok{  sigma\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
  
  \CommentTok{\# initial recruit size (mean and sd)}
\NormalTok{  mu\_R }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{25}\NormalTok{)}
\NormalTok{  sigma\_R }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{20}\NormalTok{)}
  
  \CommentTok{\# abundance of recruits (mean and sd)}
\NormalTok{  mu\_lambda }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1000000}\NormalTok{)}
\NormalTok{  sigma\_lambda }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10000}\NormalTok{)}
  
  \CommentTok{\# abundance of adults in year 1}
\NormalTok{  lambda\_A }\SpecialCharTok{\textasciitilde{}} \FunctionTok{dunif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1000000}\NormalTok{)}
  
  
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

Then declare the model data and constants, as well as generate initial
values for the MCMC:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# bundle up data and constants}
\NormalTok{constants }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \CommentTok{\# number of years}
  \AttributeTok{n\_year =} \FunctionTok{dim}\NormalTok{(H)[}\DecValTok{3}\NormalTok{],}
  \CommentTok{\# number of time periods in each year}
  \AttributeTok{totalt =}\NormalTok{ totalt,}
  \CommentTok{\# number of trap obs in year y, time t}
  \AttributeTok{totalo =}\NormalTok{ totalo,}
  \CommentTok{\# time periods to project all years to the same intra{-}annual end point}
  \AttributeTok{additionalt =}\NormalTok{ additionalt,}
  \CommentTok{\# year indices where intra{-}annual end point \textgreater{} t of last observation}
  \AttributeTok{year\_short =} \FunctionTok{which}\NormalTok{(}\FunctionTok{apply}\NormalTok{(index, }\DecValTok{2}\NormalTok{, max, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{\textless{}}
                       \FunctionTok{max}\NormalTok{(index, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)),}
  \CommentTok{\# number of years where intra{-}annual end point \textgreater{} t of last observation}
  \AttributeTok{n\_year\_short =} \FunctionTok{length}\NormalTok{(}\FunctionTok{which}\NormalTok{(}\FunctionTok{apply}\NormalTok{(index, }\DecValTok{2}\NormalTok{, max, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{\textless{}}
                                \FunctionTok{max}\NormalTok{(index, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))),}
  \CommentTok{\# number of sizes in IPM mesh}
  \AttributeTok{n\_size =} \FunctionTok{length}\NormalTok{(x),}
  \CommentTok{\# upper bounds in IPM mesh}
  \AttributeTok{upper =}\NormalTok{ b[}\DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(b)],}
  \CommentTok{\# lower bounds in IPM mesh}
  \AttributeTok{lower =}\NormalTok{ b[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(x)],}
  \CommentTok{\# binary indicator of fukui traps in time t, obs j, year i}
  \AttributeTok{f\_index =}\NormalTok{ f\_index,}
  \CommentTok{\# binary indicator of minnow traps in time t, obs j, year i}
  \AttributeTok{m\_index =}\NormalTok{ m\_index,}
  \CommentTok{\# binary indicator of shrimp traps in time t, obs j, year i}
  \AttributeTok{s\_index =}\NormalTok{ s\_index,}
  \CommentTok{\# midpoints in IPM mesh}
  \AttributeTok{x =}\NormalTok{ x,}
  \CommentTok{\# calendar date indices (fraction of year) in time t, year i}
  \AttributeTok{D =}\NormalTok{ D,}
  \CommentTok{\# maximum calendar date index}
  \AttributeTok{max\_D =} \FunctionTok{max}\NormalTok{(D, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
  \CommentTok{\# number of soak days for each trap at time t, trap j, year i}
  \AttributeTok{soak\_days =}\NormalTok{ soak\_days,}
  \CommentTok{\# data structure to introduce recruits into the model at t = 6}
  \AttributeTok{recruit\_intro =}\NormalTok{ recruit\_intro,}
  \CommentTok{\# total number of trap observations in mark{-}recapture dataset}
  \AttributeTok{totalo\_mc =}\NormalTok{ totalo\_mc,}
  \CommentTok{\# binary indicator of fukui traps in trap j of mark{-}recapture dataset}
  \AttributeTok{f\_index\_mc =}\NormalTok{ f\_index\_mc,}
  \CommentTok{\# binary indicator of shrimp traps in trap j of mark{-}recapture dataset}
  \AttributeTok{s\_index\_mc =}\NormalTok{ s\_index\_mc,}
  \CommentTok{\# binary indicator of minnow traps in trap j of mark{-}recapture dataset}
  \AttributeTok{m\_index\_mc =}\NormalTok{ m\_index\_mc,}
  \CommentTok{\# number of soak days in trap j of mark{-}recapture dataset}
  \AttributeTok{soak\_days\_mc =}\NormalTok{ soak\_days\_mc,}
  \CommentTok{\# calendar date indices (fraction of year) of mark{-}recapture dataset}
  \AttributeTok{D\_mc =}\NormalTok{ D\_mc,}
  \AttributeTok{pi =}\NormalTok{ pi,}
  \AttributeTok{ones =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(x))}
\NormalTok{)}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{H\_T =}\NormalTok{ H\_T, }\CommentTok{\# total harvested within at time t, year y, size x}
  \AttributeTok{H =}\NormalTok{ H, }\CommentTok{\# harvest count at time t, trap j, year y, size x}
  \AttributeTok{n1 =}\NormalTok{ n1\_mc, }\CommentTok{\# count of marked crabs of size y in mark{-}recapture dataset}
  \AttributeTok{m2 =}\NormalTok{ m2\_mc }\CommentTok{\# count of recaptured crabs of size x in mark{-}recapture dataset}
\NormalTok{)}


\CommentTok{\# create N\_overwinter initial values}
\NormalTok{N\_overwinter }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow =} \FunctionTok{dim}\NormalTok{(H)[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{ncol =} \FunctionTok{length}\NormalTok{(x))}
\NormalTok{adult\_mean }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{log}\NormalTok{(}\DecValTok{75}\NormalTok{), }\FunctionTok{log}\NormalTok{(}\DecValTok{80}\NormalTok{), }\FunctionTok{log}\NormalTok{(}\DecValTok{82}\NormalTok{))}
\NormalTok{mean\_recruit }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{log}\NormalTok{(}\DecValTok{55}\NormalTok{), }\FunctionTok{log}\NormalTok{(}\DecValTok{52}\NormalTok{), }\FunctionTok{log}\NormalTok{(}\DecValTok{52}\NormalTok{))}
\NormalTok{lambda\_A }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\NormalTok{lambda\_R }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{300}\NormalTok{, }\DecValTok{75}\NormalTok{, }\DecValTok{400}\NormalTok{)}
\NormalTok{adult\_sd }\OtherTok{\textless{}{-}} \FloatTok{0.08}
\NormalTok{recruit\_sd }\OtherTok{\textless{}{-}} \FloatTok{0.1}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{dim}\NormalTok{(H)[}\DecValTok{3}\NormalTok{] }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) \{}
\NormalTok{  prob\_r }\OtherTok{\textless{}{-}} \FunctionTok{dlnorm}\NormalTok{(x, mean\_recruit[i], recruit\_sd) }\SpecialCharTok{/}
    \FunctionTok{sum}\NormalTok{(}\FunctionTok{dlnorm}\NormalTok{(x, mean\_recruit[i], recruit\_sd))}
\NormalTok{  prob\_a }\OtherTok{\textless{}{-}} \FunctionTok{dlnorm}\NormalTok{(x, adult\_mean[i], adult\_sd) }\SpecialCharTok{/}
    \FunctionTok{sum}\NormalTok{(}\FunctionTok{dlnorm}\NormalTok{(x, adult\_mean[i], adult\_sd))}
\NormalTok{  N\_overwinter[i, ] }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(prob\_a }\SpecialCharTok{*}\NormalTok{ lambda\_A[i] }\SpecialCharTok{+}\NormalTok{ prob\_r }\SpecialCharTok{*}\NormalTok{ lambda\_R[i])}
\NormalTok{\}}

\CommentTok{\# initial values}
\NormalTok{inits }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{h\_M\_max =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.0001}\NormalTok{, }\FloatTok{0.0008}\NormalTok{), }\AttributeTok{h\_M\_A =} \DecValTok{44}\NormalTok{, }\AttributeTok{h\_M\_sigma =} \FloatTok{6.67}\NormalTok{,}
    \AttributeTok{h\_F\_max =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.0001}\NormalTok{, }\FloatTok{0.0008}\NormalTok{), }\AttributeTok{h\_F\_k =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{h\_F\_0 =} \DecValTok{45}\NormalTok{,}
    \AttributeTok{h\_S\_max =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.001}\NormalTok{, }\FloatTok{0.005}\NormalTok{), }\AttributeTok{h\_S\_k =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{h\_S\_0 =} \DecValTok{45}\NormalTok{,}
    \AttributeTok{ro\_dir =} \FloatTok{0.01}\NormalTok{, }\AttributeTok{beta\_alpha =} \DecValTok{2}\NormalTok{, }\AttributeTok{beta\_theta =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{alpha\_o\_alpha =} \DecValTok{2}\NormalTok{, }\AttributeTok{alpha\_o\_theta =} \DecValTok{1}\NormalTok{, }\AttributeTok{gk =} \DecValTok{1}\NormalTok{, }\AttributeTok{xinf =} \DecValTok{85}\NormalTok{,}
    \AttributeTok{C =} \FloatTok{0.79}\NormalTok{, }\AttributeTok{ts =} \SpecialCharTok{{-}}\FloatTok{0.64}\NormalTok{, }\AttributeTok{sigma\_G =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{sigma\_R =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{mu\_R =} \DecValTok{20}\NormalTok{, }\AttributeTok{mu\_A =} \DecValTok{4}\NormalTok{, }\AttributeTok{sigma\_A =} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{lambda\_A =} \DecValTok{1800}\NormalTok{, }\AttributeTok{lambda\_R =} \FunctionTok{c}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{1000}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{mu\_lambda =} \DecValTok{500}\NormalTok{,}
    \AttributeTok{sigma\_lambda =} \DecValTok{100}\NormalTok{, }\AttributeTok{beta =} \FunctionTok{rep}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\DecValTok{5}\NormalTok{),}
    \AttributeTok{alpha\_o =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0308}\NormalTok{, }\FloatTok{0.00669}\NormalTok{, }\FloatTok{0.0346}\NormalTok{), }\AttributeTok{N\_overwinter =}\NormalTok{ N\_overwinter}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Run the MCMC in parallel, including assigning the relevant nimble
functions to the parallel nodes:

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\# run MCMC in parallel \#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\NormalTok{cl }\OtherTok{\textless{}{-}} \FunctionTok{makeCluster}\NormalTok{(}\DecValTok{4}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{10120}\NormalTok{)}

\FunctionTok{clusterExport}\NormalTok{(cl, }\FunctionTok{c}\NormalTok{(}\StringTok{"model\_code"}\NormalTok{, }\StringTok{"inits"}\NormalTok{, }\StringTok{"data"}\NormalTok{, }\StringTok{"constants"}\NormalTok{, }\StringTok{"N\_overwinter"}\NormalTok{))}

\CommentTok{\# Create a function with all the needed code}
\NormalTok{out }\OtherTok{\textless{}{-}} \FunctionTok{clusterEvalQ}\NormalTok{(cl, \{}
  \FunctionTok{library}\NormalTok{(nimble)}
  \FunctionTok{library}\NormalTok{(coda)}
  \FunctionTok{library}\NormalTok{(expm)}

  \CommentTok{\# define dirichlet multinomial mixture}
  \CommentTok{\# pdf}
\NormalTok{  ddirchmulti }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{alpha =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{log =} \FunctionTok{integer}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{default =} \DecValTok{0}\NormalTok{)) \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{      logProb }\OtherTok{\textless{}{-}} \FunctionTok{lgamma}\NormalTok{(size }\SpecialCharTok{+} \DecValTok{1}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(x }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+} \FunctionTok{lgamma}\NormalTok{(}\FunctionTok{sum}\NormalTok{(alpha)) }\SpecialCharTok{{-}}
        \FunctionTok{sum}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(alpha)) }\SpecialCharTok{+} \FunctionTok{sum}\NormalTok{(}\FunctionTok{lgamma}\NormalTok{(alpha }\SpecialCharTok{+}\NormalTok{ x)) }\SpecialCharTok{{-}}
        \FunctionTok{lgamma}\NormalTok{(}\FunctionTok{sum}\NormalTok{(alpha) }\SpecialCharTok{+}\NormalTok{ size)}
      \ControlFlowTok{if}\NormalTok{ (log) }\FunctionTok{return}\NormalTok{(logProb)}
      \ControlFlowTok{else} \FunctionTok{return}\NormalTok{(}\FunctionTok{exp}\NormalTok{(logProb))}
\NormalTok{    \})}
  \CommentTok{\# distribution number generator}
\NormalTok{  rdirchmulti }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \FunctionTok{integer}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{alpha =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{)) \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{!=} \DecValTok{1}\NormalTok{) }\FunctionTok{print}\NormalTok{(}\StringTok{"rdirchmulti only allows n = 1; using n = 1."}\NormalTok{)}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{rdirch}\NormalTok{(}\DecValTok{1}\NormalTok{, alpha)}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{rmulti}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{size =}\NormalTok{ size, }\AttributeTok{prob =}\NormalTok{ p))}
\NormalTok{    \})}
  
  \FunctionTok{assign}\NormalTok{(}\StringTok{"ddirchmulti"}\NormalTok{, ddirchmulti, .GlobalEnv)}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"rdirchmulti"}\NormalTok{, rdirchmulti, .GlobalEnv)}
  
  \CommentTok{\# size selective hazard rate of trap type minnow {-} bell{-}shaped curve}
\NormalTok{  size\_sel\_norm }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \CommentTok{\# input and output types}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{pmax =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{xmax =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{sigma =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      
\NormalTok{      vector }\OtherTok{\textless{}{-}}\NormalTok{ pmax }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(x }\SpecialCharTok{{-}}\NormalTok{ xmax) }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ sigma }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{))}
      
      \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"size\_sel\_norm"}\NormalTok{, size\_sel\_norm, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# size selective hazard rate of trap type fukui and shrimp {-} logistic}
\NormalTok{  size\_sel\_log }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \CommentTok{\#input and output types}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{pmax =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{midpoint =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      
\NormalTok{      vector }\OtherTok{\textless{}{-}}\NormalTok{ pmax }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{k }\SpecialCharTok{*}\NormalTok{ (x }\SpecialCharTok{{-}}\NormalTok{ midpoint)))}
      
      \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"size\_sel\_log"}\NormalTok{, size\_sel\_log, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  
  \CommentTok{\# calculate trap hazard rate of obs j, based on trap type and soak days}
\NormalTok{  calc\_hazard }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \CommentTok{\#input and output types}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{nobs =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_F\_max =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{h\_F\_k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_F\_0 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{h\_S\_max =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_S\_k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{h\_S\_0 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_M\_max =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{h\_M\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{h\_M\_sigma =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{obs\_ref\_f =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{obs\_ref\_s =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                   \AttributeTok{obs\_ref\_m =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{soak\_days =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                   \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
      
      \CommentTok{\# create empty array}
\NormalTok{      array }\OtherTok{\textless{}{-}} \FunctionTok{array}\NormalTok{(}\AttributeTok{init =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{dim =} \FunctionTok{c}\NormalTok{(nobs, n\_size))}
      \CommentTok{\# loop through observations}
      \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs) \{}
        \CommentTok{\# P(capture)}
\NormalTok{        array[j, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\OtherTok{\textless{}{-}} \FunctionTok{size\_sel\_log}\NormalTok{(}\AttributeTok{pmax =}\NormalTok{ h\_F\_max, }\AttributeTok{k =}\NormalTok{ h\_F\_k,}
                                           \AttributeTok{midpoint =}\NormalTok{ h\_F\_0, }\AttributeTok{x =}\NormalTok{ x) }\SpecialCharTok{*}
\NormalTok{          obs\_ref\_f[j] }\SpecialCharTok{*}\NormalTok{ soak\_days[j] }\SpecialCharTok{+}
          \FunctionTok{size\_sel\_log}\NormalTok{(}\AttributeTok{pmax =}\NormalTok{ h\_S\_max, }\AttributeTok{k =}\NormalTok{ h\_S\_k, }\AttributeTok{midpoint =}\NormalTok{ h\_S\_0, }\AttributeTok{x =}\NormalTok{ x) }\SpecialCharTok{*}
\NormalTok{          obs\_ref\_s[j] }\SpecialCharTok{*}\NormalTok{ soak\_days[j] }\SpecialCharTok{+}
          \FunctionTok{size\_sel\_norm}\NormalTok{(}\AttributeTok{pmax =}\NormalTok{ h\_M\_max, }\AttributeTok{xmax =}\NormalTok{ h\_M\_A, }
                        \AttributeTok{sigma =}\NormalTok{ h\_M\_sigma, }\AttributeTok{x =}\NormalTok{ x) }\SpecialCharTok{*}
\NormalTok{          obs\_ref\_m[j] }\SpecialCharTok{*}\NormalTok{ soak\_days[j]}
\NormalTok{      \}}
      
      \FunctionTok{return}\NormalTok{(array)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"calc\_hazard"}\NormalTok{, calc\_hazard, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# calculate conditional probability of capture}
\NormalTok{  calc\_cond\_prob }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \CommentTok{\#input and output types}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{nobs =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{hazard =} \FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
      
      \CommentTok{\# create empty array}
\NormalTok{      array }\OtherTok{\textless{}{-}} \FunctionTok{array}\NormalTok{(}\AttributeTok{init =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{dim =} \FunctionTok{c}\NormalTok{(nobs, n\_size))}
      
      \CommentTok{\# loop through sizes}
      \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
        \CommentTok{\#P(capture in trap j | captured at all)}
\NormalTok{        array[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k] }\OtherTok{\textless{}{-}}\NormalTok{ hazard[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k] }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(hazard[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k])}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(array)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"calc\_cond\_prob"}\NormalTok{, calc\_cond\_prob, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  
  \CommentTok{\# calculate total capture probability}
\NormalTok{  calc\_prob }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \CommentTok{\#input and output types}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{nobs =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{hazard =} \FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      
      \CommentTok{\# create empty array}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, n\_size)}
      
      \CommentTok{\# loop through sizes}
      \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
        \CommentTok{\# 1 {-} exp({-}P(captured at all))}
\NormalTok{        p[k] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{sum}\NormalTok{(hazard[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{nobs, k]))}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"calc\_prob"}\NormalTok{, calc\_prob, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# function for seasonal growth kernel {-}{-} biweekly time step}
\NormalTok{  get\_kernel }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    \CommentTok{\# input and output types}
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{xinf =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{k =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{sigma\_G =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{C =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{ts =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{t1 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{t2 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{pi =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                   \AttributeTok{lower =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{S =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
      
      \CommentTok{\# create empty array}
\NormalTok{      array }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{ncol =}\NormalTok{ n\_size, }\AttributeTok{nrow =}\NormalTok{ n\_size)}
      
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(t2) }\SpecialCharTok{\&}\NormalTok{ t2 }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
\NormalTok{        array }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(n\_size)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
        \CommentTok{\# season adjusted params}
\NormalTok{        S\_t }\OtherTok{\textless{}{-}}\NormalTok{ (C }\SpecialCharTok{*}\NormalTok{ k }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*}\NormalTok{ (t2 }\SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ ts)))}
\NormalTok{        S\_t0 }\OtherTok{\textless{}{-}}\NormalTok{ (C }\SpecialCharTok{*}\NormalTok{ k }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)) }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi }\SpecialCharTok{*}\NormalTok{ (t1 }\SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ ts)))}
        
        \CommentTok{\# p(y"|y)}
        \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{          increment }\OtherTok{\textless{}{-}}\NormalTok{ (xinf }\SpecialCharTok{{-}}\NormalTok{ x[i]) }\SpecialCharTok{*}
\NormalTok{            (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{k }\SpecialCharTok{*}\NormalTok{ (t2 }\SpecialCharTok{{-}}\NormalTok{ t1) }\SpecialCharTok{{-}}\NormalTok{ S\_t }\SpecialCharTok{+}\NormalTok{ S\_t0))}
\NormalTok{          mean }\OtherTok{\textless{}{-}}\NormalTok{ x[i] }\SpecialCharTok{+}\NormalTok{ increment}
\NormalTok{          array[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size, i] }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{pnorm}\NormalTok{(upper, mean, }\AttributeTok{sd =}\NormalTok{ sigma\_G) }\SpecialCharTok{{-}}
                                   \FunctionTok{pnorm}\NormalTok{(lower, mean, }\AttributeTok{sd =}\NormalTok{ sigma\_G))}
\NormalTok{        \}}
        
        \CommentTok{\# normalize and apply natural mortality}
        \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size) \{}
\NormalTok{          array[, i] }\OtherTok{\textless{}{-}}\NormalTok{ array[, i] }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(array[, i]) }\SpecialCharTok{*}\NormalTok{ S}
\NormalTok{        \}}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(array)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"get\_kernel"}\NormalTok{, get\_kernel, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# initial size distribution of adults {-} year 1}
\NormalTok{  get\_init\_adult }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{mu\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{sigma\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{lower =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                   \AttributeTok{lambda\_A =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      
\NormalTok{      prop\_adult }\OtherTok{\textless{}{-}} \FunctionTok{plnorm}\NormalTok{(}\AttributeTok{q =}\NormalTok{ upper, }\AttributeTok{meanlog =}\NormalTok{ mu\_A, }\AttributeTok{sdlog =}\NormalTok{ sigma\_A) }\SpecialCharTok{{-}}
        \FunctionTok{plnorm}\NormalTok{(}\AttributeTok{q =}\NormalTok{ lower, }\AttributeTok{meanlog =}\NormalTok{ mu\_A, }\AttributeTok{sdlog =}\NormalTok{ sigma\_A)}
      
      \CommentTok{\# get initial size{-}structured abundance of adults}
\NormalTok{      out }\OtherTok{\textless{}{-}}\NormalTok{ prop\_adult }\SpecialCharTok{*}\NormalTok{ lambda\_A}
      
      \FunctionTok{return}\NormalTok{(out)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"get\_init\_adult"}\NormalTok{, get\_init\_adult, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# annual size distributions of recruit}
\NormalTok{  get\_init\_recruits }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{mu\_R =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{sigma\_R =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{lower =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{upper =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                   \AttributeTok{lambda\_R =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{n\_year =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{n\_size =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{2}\NormalTok{))}
      
      \CommentTok{\# create empty array}
\NormalTok{      out }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{ncol =}\NormalTok{ n\_size, }\AttributeTok{nrow =}\NormalTok{ n\_year)}
      
      \CommentTok{\# moment match from normal to gamma}
\NormalTok{      var }\OtherTok{\textless{}{-}}\NormalTok{ sigma\_R }\SpecialCharTok{\^{}} \DecValTok{2}
\NormalTok{      shape }\OtherTok{\textless{}{-}}\NormalTok{ mu\_R }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{/}\NormalTok{ var}
\NormalTok{      rate }\OtherTok{\textless{}{-}}\NormalTok{ mu\_R }\SpecialCharTok{/}\NormalTok{ var}
\NormalTok{      prop\_recruit }\OtherTok{\textless{}{-}} \FunctionTok{pgamma}\NormalTok{(}\AttributeTok{q =}\NormalTok{ upper, }\AttributeTok{shape =}\NormalTok{ shape, }\AttributeTok{rate =}\NormalTok{ rate) }\SpecialCharTok{{-}}
        \FunctionTok{pgamma}\NormalTok{(}\AttributeTok{q =}\NormalTok{ lower, }\AttributeTok{shape =}\NormalTok{ shape, }\AttributeTok{rate =}\NormalTok{ rate)}
      
      \CommentTok{\# get initial size{-}structured abundance of recruits}
      \ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_year) \{}
\NormalTok{        out[y, ] }\OtherTok{\textless{}{-}}\NormalTok{ prop\_recruit[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_size] }\SpecialCharTok{*}\NormalTok{ lambda\_R[y]}
\NormalTok{      \}}
      
      \FunctionTok{return}\NormalTok{(out)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"get\_init\_recruits"}\NormalTok{, get\_init\_recruits, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# natural (non{-}winter) survival}
\NormalTok{  survival }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{alpha =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{beta =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                   \AttributeTok{t1 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{t2 =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      
      \CommentTok{\# number of biweeks}
\NormalTok{      deltat }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{((t2 }\SpecialCharTok{{-}}\NormalTok{ t1) }\SpecialCharTok{*}\NormalTok{ (}\FloatTok{52.1429} \SpecialCharTok{/} \DecValTok{2}\NormalTok{))}
      
      \CommentTok{\# get survival rate}
\NormalTok{      out }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{deltat }\SpecialCharTok{*}\NormalTok{ (beta }\SpecialCharTok{+}\NormalTok{ alpha }\SpecialCharTok{/}\NormalTok{ x }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{))}
      
      \FunctionTok{return}\NormalTok{(out)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"survival"}\NormalTok{, survival, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  \CommentTok{\# density{-} and size{-}dependent overwinter survival}
\NormalTok{  overwinter\_survival }\OtherTok{\textless{}{-}} \FunctionTok{nimbleFunction}\NormalTok{ (}
    
    \AttributeTok{run =} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{alpha\_o =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{), }\AttributeTok{N\_sum =} \FunctionTok{double}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                   \AttributeTok{x =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{    \{}
      \FunctionTok{returnType}\NormalTok{(}\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
      
      \CommentTok{\# get probability of survival}
\NormalTok{      out }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(alpha\_o }\SpecialCharTok{*}\NormalTok{ N\_sum }\SpecialCharTok{/}\NormalTok{ x }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{))}
      
      \FunctionTok{return}\NormalTok{(out)}
\NormalTok{    \}}
\NormalTok{  )}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"overwinter\_survival"}\NormalTok{, overwinter\_survival, }\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
  
  
  \CommentTok{\# build model}
\NormalTok{  myModel }\OtherTok{\textless{}{-}} \FunctionTok{nimbleModel}\NormalTok{(}\AttributeTok{code =}\NormalTok{ model\_code,}
                         \AttributeTok{data =}\NormalTok{ data,}
                         \AttributeTok{constants =}\NormalTok{ constants,}
                         \AttributeTok{inits =} \FunctionTok{inits}\NormalTok{())}
  
  
  \CommentTok{\# build the MCMC}
\NormalTok{  mcmcConf\_myModel }\OtherTok{\textless{}{-}} \FunctionTok{configureMCMC}\NormalTok{(}
\NormalTok{    myModel,}
    \AttributeTok{monitors =} \FunctionTok{c}\NormalTok{(}\StringTok{"h\_M\_max"}\NormalTok{, }\StringTok{"h\_M\_A"}\NormalTok{, }\StringTok{"h\_M\_sigma"}\NormalTok{, }\StringTok{"h\_F\_max"}\NormalTok{,}
                 \StringTok{"h\_F\_k"}\NormalTok{, }\StringTok{"h\_F\_0"}\NormalTok{, }\StringTok{"h\_S\_max"}\NormalTok{, }\StringTok{"h\_S\_k"}\NormalTok{,}
                 \StringTok{"h\_S\_0"}\NormalTok{, }\StringTok{"beta\_alpha"}\NormalTok{, }\StringTok{"beta\_theta"}\NormalTok{, }\StringTok{"gk"}\NormalTok{,}
                 \StringTok{"xinf"}\NormalTok{, }\StringTok{"C"}\NormalTok{, }\StringTok{"ts"}\NormalTok{, }\StringTok{"sigma\_G"}\NormalTok{,}
                 \StringTok{"sigma\_R"}\NormalTok{, }\StringTok{"mu\_R"}\NormalTok{, }\StringTok{"mu\_A"}\NormalTok{,}
                 \StringTok{"sigma\_A"}\NormalTok{, }\StringTok{"mu\_lambda"}\NormalTok{, }\StringTok{"sigma\_lambda"}\NormalTok{,}
                 \StringTok{"lambda\_R"}\NormalTok{, }\StringTok{"lambda\_A"}\NormalTok{, }\StringTok{"beta"}\NormalTok{, }\StringTok{"alpha\_o"}\NormalTok{,}
                 \StringTok{"alpha"}\NormalTok{, }\StringTok{"beta\_alpha"}\NormalTok{, }\StringTok{"beta\_theta"}\NormalTok{,}
                 \StringTok{"alpha\_o\_alpha"}\NormalTok{, }\StringTok{"alpha\_o\_theta"}\NormalTok{, }\StringTok{"N\_overwinter"}\NormalTok{,}
                 \StringTok{"wgrowth\_N\_sum"}\NormalTok{, }\StringTok{"ro\_dir"}\NormalTok{),}
    \AttributeTok{useConjugacy =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{enableWAIC =} \ConstantTok{TRUE}\NormalTok{)}

  \CommentTok{\# add block sampler for nmort params}
\NormalTok{  mcmcConf\_myModel}\SpecialCharTok{$}\FunctionTok{removeSamplers}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"beta\_alpha"}\NormalTok{, }\StringTok{"beta\_theta"}\NormalTok{))    }
\NormalTok{  mcmcConf\_myModel}\SpecialCharTok{$}\FunctionTok{addSampler}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"beta\_alpha"}\NormalTok{, }\StringTok{"beta\_theta"}\NormalTok{),}
                                \AttributeTok{type =} \StringTok{"RW\_block"}\NormalTok{)}
\NormalTok{  mcmcConf\_myModel}\SpecialCharTok{$}\FunctionTok{removeSamplers}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"alpha\_o\_alpha"}\NormalTok{, }\StringTok{"alpha\_o\_theta"}\NormalTok{))  }
\NormalTok{  mcmcConf\_myModel}\SpecialCharTok{$}\FunctionTok{addSampler}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"alpha\_o\_alpha"}\NormalTok{, }\StringTok{"alpha\_o\_theta"}\NormalTok{),}
                              \AttributeTok{type =} \StringTok{"RW\_block"}\NormalTok{)}

  \CommentTok{\# build MCMC}
\NormalTok{  myMCMC }\OtherTok{\textless{}{-}} \FunctionTok{buildMCMC}\NormalTok{(mcmcConf\_myModel)}

  \CommentTok{\# compile the model and MCMC}
\NormalTok{  CmyModel }\OtherTok{\textless{}{-}} \FunctionTok{compileNimble}\NormalTok{(myModel)}

  \CommentTok{\# compile the MCMC}
\NormalTok{  cmodel\_mcmc }\OtherTok{\textless{}{-}} \FunctionTok{compileNimble}\NormalTok{(myMCMC, }\AttributeTok{project =}\NormalTok{ myModel)}

  \CommentTok{\# run MCMC}
\NormalTok{  cmodel\_mcmc}\SpecialCharTok{$}\FunctionTok{run}\NormalTok{(}\DecValTok{100000}\NormalTok{, }\AttributeTok{thin =} \DecValTok{10}\NormalTok{,}
                  \AttributeTok{reset =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{  samples }\OtherTok{\textless{}{-}} \FunctionTok{as.mcmc}\NormalTok{(}\FunctionTok{as.matrix}\NormalTok{(cmodel\_mcmc}\SpecialCharTok{$}\NormalTok{mvSamples))}

  \FunctionTok{return}\NormalTok{(samples)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

Finally, save the samples and stop the cluster:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# save samples}
\FunctionTok{saveRDS}\NormalTok{(out, }\StringTok{"savedsamples\_IPM.rds"}\NormalTok{)}

\FunctionTok{stopCluster}\NormalTok{(cl)}
\end{Highlighting}
\end{Shaded}


\end{document}
